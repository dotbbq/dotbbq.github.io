<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>301 on UNIXETC</title>
    <link>https://unixetc.com/tags/301/</link>
    <description>UNIXETC (301)</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Fri, 01 Jul 2016 17:21:00 +0000</lastBuildDate>
    
    <atom:link href="https://unixetc.com/tags/301/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>HSTS域名更换实例</title>
      <link>https://unixetc.com/post/hsts-domain-name-replacement-examples/</link>
      <pubDate>Fri, 01 Jul 2016 17:21:00 +0000</pubDate>
      
      <guid>https://unixetc.com/post/hsts-domain-name-replacement-examples/</guid>
      <description>&lt;p&gt;新入手了its0k.com，原来的alair.cn还继续使用&lt;/p&gt;
&lt;p&gt;在这里需要将alair.cn重定向到its0k.com&lt;/p&gt;
&lt;p&gt;第一次只是将&lt;code&gt;nginx&lt;/code&gt;配置文件中的&lt;code&gt;alair.cn&lt;/code&gt;全部替换为&lt;code&gt;its0k.com&lt;/code&gt;，通过its0k.com浏览新站完全没问题&lt;/p&gt;
&lt;p&gt;但是试着从alair.cn跳转浏览新站，浏览器出现了证书安全告警，告警具体原因为证书未包含&lt;code&gt;alair.cn&lt;/code&gt;域名，我才想起来旧域名&lt;code&gt;alair.cn&lt;/code&gt;已经添加进了&lt;code&gt;HSTS&lt;/code&gt;列表，因此不能简单的只为新域名签名，而是需要证书签名时包含新旧两个域名。&lt;/p&gt;
&lt;p&gt;重新签名了证书，包含以下四个域名&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;its0k.com www.its0k.com alair.cn www.alair.cn
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;以下为更改完成后的&lt;code&gt;nginx&lt;/code&gt;配置文件，请注意名相关的部分&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;server {
listen 443 ssl http2;

ssl_certificate     /root/ssls/its0k.crt;
ssl_certificate_key /root/ssls/its0k.key;

ssl_session_timeout 60m;
ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-RC4-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:RC4-SHA:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!DSS:!PKS;
ssl_prefer_server_ciphers on;
ssl_session_cache builtin:1000 shared:SSL:10m;
ssl_dhparam /etc/ssl/certs/dhparam.pem;

add_header Strict-Transport-Security &amp;quot;max-age=63072000; includeSubdomains; preload&amp;quot;;
add_header X-Frame-Options &amp;quot;DENY&amp;quot;;

ssl_stapling on;
ssl_stapling_verify on;

resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;

server_name its0k.com www.its0k.com alair.cn www.alair.cn;
access_log off;
index index.html index.htm;
include /usr/local/nginx/conf/rewrite/ps.conf;
root /data/wwwroot/its0k.com/compiled;
error_page 403 404 500 503 505 = https://its0k.com/404;
if ($host != its0k.com) {
        rewrite ^/(.*)$ $scheme://its0k.com/$1 permanent;
        }

location ~ .*\.(gif|svg|jpg|jpeg|png|bmp|swf|flv|ico)$ {
    expires 30d;
    access_log off;
    }
location ~ .*\.(js|css)?$ {
    expires 7d;
    access_log off;
    }
}
server {
listen 80;
server_name www.its0k.com its0k.com alair.cn www.alair.cn;
add_header Strict-Transport-Security &amp;quot;max-age=63072000; includeSubdomains; preload&amp;quot;;
rewrite ^/(.*) https://its0k.com/$1 permanent;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;至此域名替换完成！&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>StartSSL免费证书与Nginx配置</title>
      <link>https://unixetc.com/post/startssl-and-nginx/</link>
      <pubDate>Wed, 14 Oct 2015 12:13:00 +0000</pubDate>
      
      <guid>https://unixetc.com/post/startssl-and-nginx/</guid>
      <description>&lt;h3 id=&#34;注册startssl&#34;&gt;注册StartSSL&lt;/h3&gt;
&lt;p&gt;打开&lt;a href=&#34;https://www.startssl.com/&#34;&gt;https://www.startssl.com/&lt;/a&gt;，点击&lt;strong&gt;Sign-up&lt;/strong&gt;开始注册&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/sign-up-startssl.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;参考上图填写注册信息，然后&lt;strong&gt;Continue&lt;/strong&gt;，会有如下提示，系统会发送验证码到你的注册邮箱&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/CR.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;检查注册邮箱，将收到的验证码填写提交，然后会出现如下提示，等待审核。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/Additional_Verification_Required.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;审核通过后，会收到如下提示邮件，点击其中连接，然后输入邮箱中的验证码完成注册&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/StartSSL_Account_Request.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/complete_registration.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;安装证书&#34;&gt;安装证书&lt;/h3&gt;
&lt;p&gt;接下来创建私匙&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/gpk.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;安装证书&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/install_cert.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;安装成功后会有如下提示&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/cif.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/fic.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;验证域名&#34;&gt;验证域名&lt;/h3&gt;
&lt;p&gt;接下来验证域名，点击&lt;strong&gt;Validations Wizard&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/select_Validation.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;填写域名&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/enter_domain_name.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;选择验证邮件地址&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/select_Validation_email.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;按照提示输入邮箱接收到的验证码完成验证。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/complete_Validation_domain.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;创建证书&#34;&gt;创建证书&lt;/h3&gt;
&lt;p&gt;选择&lt;strong&gt;Certificates Wizard&lt;/strong&gt;，证书目标选择&lt;strong&gt;Web Server SSL/TLS Certificate&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/Select_Certificate_Purpose.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;接下来新建私匙&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/Generate_Private_key.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;点击&lt;strong&gt;Skip&lt;/strong&gt;跳过系统建立步骤，我们自己在VPS上建立CSR文件，参考下图通过&lt;code&gt;openssl&lt;/code&gt;命令建立CSR文件&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/create_scr_file.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;注意，为了便于后期安装配置方便，建议密码置空&lt;/p&gt;
&lt;p&gt;完成后，&lt;code&gt;cat&lt;/code&gt;出建立好的&lt;strong&gt;ciuxsss.csr&lt;/strong&gt;内容，粘贴提交&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/Submit_Certificate_Request.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/Certificate_Request_Received.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;接下来添加域名&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/add_domains.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/add_sub_domain.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/Ready_Processing_Certificate.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;接下来将文本框中的内容保存为一个**.crt**文件&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://cdn.lyq.wiki/imgs/Save_Certificate.webp&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;配置nginx&#34;&gt;配置Nginx&lt;/h3&gt;
&lt;p&gt;贴出我的配置文件，大家参考一下&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;server {
    listen 80;
    location /{
    return 301 https://$host$request_uri;
    }
}

server
    {
        listen 443;
        #listen 80;
        #listen [::]:80;
        server_name ciux.org;
        index index.html index.htm index.php default.html default.htm default.php;
        root  /home/ciux/compiled;

ssl    on;
ssl_certificate    /home/bk/ssl/ciuxsss.crt;
ssl_certificate_key     /home/bk/ssl/ciuxsss.key;
ssl_session_timeout 5m;

ssl_protocols SSLv2 SSLv3 TLSv1;
ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;
ssl_prefer_server_ciphers   on;

……
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;其中第一个Server是将所有80端口的http访问301重定向到443端口的https访问。&lt;/p&gt;
&lt;p&gt;如果发现浏览器提示证书不被信任，那就需要合并Startssl的根证书&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;wget http://cert.startssl.com/certs/sub.class1.server.ca.pem  
cat sub.class1.server.ca.pem &amp;gt;&amp;gt; ciuxsss.crt&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
  </channel>
</rss>