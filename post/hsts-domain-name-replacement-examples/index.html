<!DOCTYPE html>


<html lang="zh-cn" data-theme="">
<head>
    
        
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer-when-downgrade">

<title>HSTS域名更换实例 - UNIXETC</title>
<meta name="description" content="A Personal Site">

<link rel="icon" type="image/x-icon" href="https://unixetc.com/favicon.ico">
<link rel="apple-touch-icon-precomposed" href="https://unixetc.com/favicon.png">

<link rel="stylesheet" href="https://unixetc.com/css/light.css?rnd=1596103041" />
<style>

    [data-theme="dark"] {   
        --font-color: #eee;
--bg-color: #212121;

--link-color:#599ada;
--link-state-color:#ff5858;
--link-state-border-color: rgba(238, 54, 54, 0.5);

--thead-bg-color: #343a40;
--table-border-color: lightgrey;

--pre-color: #333;
--pre-bg-color: #f1f1f1;

--bq-color: #ccc;
--hr-color: #333;

--pagination-bg-color: #373737;
--pagination-link-color: #b6b6b6;

--post-info-color: grey;

--switcher-color: #333;
--switcher-bg-color: #fff;

    }

</style>

<link rel="stylesheet" href="https://unixetc.com/css/style.css?rnd=1596103041" />





<meta property="og:title" content="HSTS域名更换实例" />
<meta property="og:description" content="新入手了its0k.com，原来的alair.cn还继续使用
在这里需要将alair.cn重定向到its0k.com
第一次只是将nginx配置文件中的alair.cn全部替换为its0k.com，通过its0k.com浏览新站完全没问题
但是试着从alair.cn跳转浏览新站，浏览器出现了证书安全告警，告警具体原因为证书未包含alair.cn域名，我才想起来旧域名alair.cn已经添加进了HSTS列表，因此不能简单的只为新域名签名，而是需要证书签名时包含新旧两个域名。
重新签名了证书，包含以下四个域名
its0k.com www.its0k.com alair.cn www.alair.cn  以下为更改完成后的nginx配置文件，请注意名相关的部分
server { listen 443 ssl http2; ssl_certificate /root/ssls/its0k.crt; ssl_certificate_key /root/ssls/its0k.key; ssl_session_timeout 60m; ssl_protocols TLSv1 TLSv1.1 TLSv1.2; ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-RC4-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:RC4-SHA:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!DSS:!PKS; ssl_prefer_server_ciphers on; ssl_session_cache builtin:1000 shared:SSL:10m; ssl_dhparam /etc/ssl/certs/dhparam.pem; add_header Strict-Transport-Security &quot;max-age=63072000; includeSubdomains; preload&quot;; add_header X-Frame-Options &quot;DENY&quot;; ssl_stapling on; ssl_stapling_verify on; resolver 8.8.8.8 8.8.4.4 valid=300s; resolver_timeout 5s; server_name its0k.com www.its0k.com alair.cn www.alair.cn; access_log off; index index.html index.htm; include /usr/local/nginx/conf/rewrite/ps.conf; root /data/wwwroot/its0k.com/compiled; error_page 403 404 500 503 505 = https://its0k." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://unixetc.com/post/hsts-domain-name-replacement-examples/" />
<meta property="article:published_time" content="2016-07-01T17:21:00+00:00" />
<meta property="article:modified_time" content="2016-07-01T17:21:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HSTS域名更换实例"/>
<meta name="twitter:description" content="新入手了its0k.com，原来的alair.cn还继续使用
在这里需要将alair.cn重定向到its0k.com
第一次只是将nginx配置文件中的alair.cn全部替换为its0k.com，通过its0k.com浏览新站完全没问题
但是试着从alair.cn跳转浏览新站，浏览器出现了证书安全告警，告警具体原因为证书未包含alair.cn域名，我才想起来旧域名alair.cn已经添加进了HSTS列表，因此不能简单的只为新域名签名，而是需要证书签名时包含新旧两个域名。
重新签名了证书，包含以下四个域名
its0k.com www.its0k.com alair.cn www.alair.cn  以下为更改完成后的nginx配置文件，请注意名相关的部分
server { listen 443 ssl http2; ssl_certificate /root/ssls/its0k.crt; ssl_certificate_key /root/ssls/its0k.key; ssl_session_timeout 60m; ssl_protocols TLSv1 TLSv1.1 TLSv1.2; ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-RC4-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:RC4-SHA:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!DSS:!PKS; ssl_prefer_server_ciphers on; ssl_session_cache builtin:1000 shared:SSL:10m; ssl_dhparam /etc/ssl/certs/dhparam.pem; add_header Strict-Transport-Security &quot;max-age=63072000; includeSubdomains; preload&quot;; add_header X-Frame-Options &quot;DENY&quot;; ssl_stapling on; ssl_stapling_verify on; resolver 8.8.8.8 8.8.4.4 valid=300s; resolver_timeout 5s; server_name its0k.com www.its0k.com alair.cn www.alair.cn; access_log off; index index.html index.htm; include /usr/local/nginx/conf/rewrite/ps.conf; root /data/wwwroot/its0k.com/compiled; error_page 403 404 500 503 505 = https://its0k."/>








    
</head>
<body>
    <a class="skip-main" href="#main">Skip to main content</a>
    <div class="container">
        <header class="common-header"> 
            
                <h1 class="site-title">
    <a href="/">UNIXETC</a>
</h1>
<nav>
    
    
    <a class="" href="https://unixetc.com/tags/" title="">Tags</a>
    
    <a class="" href="https://unixetc.com/readme/" title="ReadMe">Readme</a>
    
</nav>

            
        </header>
        <main id="main" tabindex="-1"> 
            
    
    
    <article class="post">
        <header class="post-header">
            <h1 class="post-title">HSTS域名更换实例</h1>
        </header>
        <div class="content">
            <p>新入手了its0k.com，原来的alair.cn还继续使用</p>
<p>在这里需要将alair.cn重定向到its0k.com</p>
<p>第一次只是将<code>nginx</code>配置文件中的<code>alair.cn</code>全部替换为<code>its0k.com</code>，通过its0k.com浏览新站完全没问题</p>
<p>但是试着从alair.cn跳转浏览新站，浏览器出现了证书安全告警，告警具体原因为证书未包含<code>alair.cn</code>域名，我才想起来旧域名<code>alair.cn</code>已经添加进了<code>HSTS</code>列表，因此不能简单的只为新域名签名，而是需要证书签名时包含新旧两个域名。</p>
<p>重新签名了证书，包含以下四个域名</p>
<pre><code>its0k.com www.its0k.com alair.cn www.alair.cn
</code></pre>
<p>以下为更改完成后的<code>nginx</code>配置文件，请注意名相关的部分</p>
<pre><code>server {
listen 443 ssl http2;

ssl_certificate     /root/ssls/its0k.crt;
ssl_certificate_key /root/ssls/its0k.key;

ssl_session_timeout 60m;
ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-RC4-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:RC4-SHA:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!DSS:!PKS;
ssl_prefer_server_ciphers on;
ssl_session_cache builtin:1000 shared:SSL:10m;
ssl_dhparam /etc/ssl/certs/dhparam.pem;

add_header Strict-Transport-Security &quot;max-age=63072000; includeSubdomains; preload&quot;;
add_header X-Frame-Options &quot;DENY&quot;;

ssl_stapling on;
ssl_stapling_verify on;

resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;

server_name its0k.com www.its0k.com alair.cn www.alair.cn;
access_log off;
index index.html index.htm;
include /usr/local/nginx/conf/rewrite/ps.conf;
root /data/wwwroot/its0k.com/compiled;
error_page 403 404 500 503 505 = https://its0k.com/404;
if ($host != its0k.com) {
        rewrite ^/(.*)$ $scheme://its0k.com/$1 permanent;
        }

location ~ .*\.(gif|svg|jpg|jpeg|png|bmp|swf|flv|ico)$ {
    expires 30d;
    access_log off;
    }
location ~ .*\.(js|css)?$ {
    expires 7d;
    access_log off;
    }
}
server {
listen 80;
server_name www.its0k.com its0k.com alair.cn www.alair.cn;
add_header Strict-Transport-Security &quot;max-age=63072000; includeSubdomains; preload&quot;;
rewrite ^/(.*) https://its0k.com/$1 permanent;
}
</code></pre>
<p>至此域名替换完成！</p>

        </div>
        


<div class="post-info">
    
        <div class="post-date">2016-07-01</div>
    
    <div class="post-taxonomies">
        
            <ul class="post-categories">
                
                    <li><a href="https://unixetc.com/categories/STUFF">STUFF</a></li>
                
            </ul>
            
            
                <ul class="post-tags">
                    
                        <li><a href="https://unixetc.com/tags/%E5%9F%9F%E5%90%8D">#域名</a></li>
                    
                        <li><a href="https://unixetc.com/tags/domainname">#DomainName</a></li>
                    
                        <li><a href="https://unixetc.com/tags/hsts">#HSTS</a></li>
                    
                        <li><a href="https://unixetc.com/tags/https">#https</a></li>
                    
                        <li><a href="https://unixetc.com/tags/301">#301</a></li>
                    
                </ul>
        
    </div>
</div>

    </article>

    

    


        </main>
        
            <footer class="common-footer">
    
    

    <div class="copyright">
        <p>© Alair, 2020<br>
        Powered by <a target="_blank" rel="noopener noreferrer" href="https://gohugo.io/">Hugo</a>, theme <a target="_blank" rel="noopener noreferrer" href="https://github.com/mitrichius/hugo-theme-anubis">Anubis</a>.CDN by <a href="https://dwz.cn/juw2S2At" target="_blank">Qiniu</a>,Host by <a href="https://dwz.cn/CdAD0bNi" target="_blank">BWG</a>.<script type="text/javascript" src="//js.users.51.la/20892031.js"></script>
        </p>  
    </div> 

    


    
</footer>

        
    </div>
</body>
</html>
